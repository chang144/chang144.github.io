learn form https://xiaolincoding.com/network/1_base/tcp_ip_model.html

# 2.1 TCP/IP网络模型

---

前言：为什么要有TCP/IP网络模型？

>  答：为了提供一套 **通用的网络协议**

因为在一台设备上的进程间通信有很多方式，比如管道、消息队列、共享内存、信号等方式，而对于不同的设备上的进程间通信，就需要网络通信，而设备是多样性的，需要兼容多种多样的设备，就需要一套 `通用的网络协议`

这个网络协议是分层的，每一层都有各自的作用和责任

> TCP/IP网络模型分为4层：应用层-->传输层-->网络层-->网络接口层(由上到下)

接下来根据 [TCP/IP 网络模型 ]分别对每一层进行介绍：

## 应用层（最上层）

---

最上层的，也是我们能直接接触到的就是**应用层**(Application Layer)，我们使用的应用软件都是在应用层实现的，当两台不同的设备的应用需要通信的时候，应用就把应用数据传给下一层，也就是**传输层**。

> **应用层**接收数据后把数据传入**传输层**

所以，**应用层**只需要专注于为用户提供应用功能，比如HTTP、FTP、Telnet、DNS、SMTP等

应用层不用关心数据是如何传输

> **应用层**是工作在操作系统的用户态，**传输层及其一下**则工作在内核态

## 传输层

---

**应用层**的数据包会传输到传输层，**传输层**(Transport Layer) 是为应用层提供网络支持

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/https/%E5%BA%94%E7%94%A8%E5%B1%82.png)

在**传输层**会有两个传输协议，分别为`TCP`和`UDP`

**TCP**的全称是“传输控制协议”(Transmission Control Protocol)，大部分应用使用的正是TCP传输层协议，比如HTTP应用层协议。

> **TCP**有很多特征：流量控制、超时重传、拥塞控制等，这些保证了数据包能可靠地传输给对方

**UDP**相对来说比较协议，简单到**只负责发送数据包**，不保证数据包是否能抵达对方，但是实时性相对更好，传输效率也高。

> **UDP**也可以实现可靠传输，把**TCP**的特性在应用层上实现就行，（不过要实现一个商用的可靠UDP传输协议也不简单）

应用需要传输的数据可能会非常大，如果直接传输就不好控制，因此当传输层的数据包大小超过**MSS**（TCP最大报文段长度），就要将数据包分块，这样即使在传输过程中一个分块缺失或者损坏了，只需要重新发送这一分开，而不用重新发送整个数据包。

在TCP协议中，每一个分块称为一个**TCP段**(TCP Segment)

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/https/TCP%E6%AE%B5.png)

当设备作为接收方时，传输层则要负责把数据包传给应用层，但是一台设备上可能会有很多应用在接收或者传输数据，因此需要一个编号将应用区分开来，这个编号就是**端口**

比如 80 端口通常是 Web 服务器用的，22 端口通常是远程登录服务器用的。而对于浏览器（客户端）中的每个标签栏都是一个独立的进程，操作系统会为这些进程分配临时的端口号。

由于传输层的报文中会携带端口号，因此接收方可以识别出该报文是发送给哪个应用。

> **传输层**并不负责将数据从一个设备传输到另一个设备

## 网络层

---

在实际场景中，一个设备的数据要传输给另一个设备，就需要在各种各样的路径和节点进行选择，其中的网络环节是错综复杂的。而**传输层**的设计理念是简单、高效、专注，如果传输层还负责这一块功能就有点违背设计原则

我们不希望传输层协议处理太多的事情，只需要服务好应用即可，让其作为应用间数据传输的媒介，帮助实现应用到应用的通信，而实际的传输功能就交给下一层，也就是**网络层**(Internet Layer)

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/https/%E7%BD%91%E7%BB%9C%E5%B1%82.png)

> 个人理解：应用层把大量的数据发送给传输层，传输层将这些大量的数据进行打包，分段，确定好目的应用，然后由网络层进行传输。

**网络层**最常用的是**IP协议**(Internet Protocol)，IP协议会将传输层的报文作为数据部分，再加上IP包头组装成**IP报文**，如果IP报文大小超过了**MTU**(以太网中一般为1500字节)就会**再次进行分片**，得到一个继续发送网络的IP报文

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/12.jpg)

**网络层**负责将数据从一个设备传输到另一个设备，但是世界上那么多设备，如何找到对方呢，因此，网络层需要有区分设备的编号

一般用**IP地址**给设备进行编号，对于IPv4协议，IP地址共32位，分成了四段（比如127.0.0.1，分成四段，每段8位）。但是寻址起来特别麻烦，不能一个一个去匹配。

因此，需要将IP地址分成两种意义：

+ 一个是**网络号**，负责标识该IP地址是属于那个[ 子网 ]的
+ 一个是**主机号**，负责标识同一[ 子网 ]下的不同主机

怎么区分**网络号**和**主机号**呢？这需要配合**子网掩码**才能算出IP地址的网络号和主机号

举个例子，比如 10.100.122.0/24，后面的`/24`表示就是 `255.255.255.0` 子网掩码，255.255.255.0 二进制是「11111111-11111111-11111111-00000000」，大家数数一共多少个1？不用数了，是 24 个1，为了简化子网掩码的表示，用/24代替255.255.255.0。

知道了子网掩码，该怎么计算出网络地址和主机地址呢？

将 10.100.122.2 和 255.255.255.0 进行**按位与运算**，就可以得到网络号，如下图：

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/16.jpg)

将 255.255.255.0 取反后与IP地址进行进行**按位与运算**，就可以得到主机号

> ~255.255.255.0 = 0.0.0.255 

除了寻找能力，IP协议还有另一个重要的能力是**路由**。实际场景中，两台设备并不是用一条网线连接，而是通过很多网关、路由器、交换机等众多网络设备连接起来的。那么就会形成很多条网络的路径，因此当数据包到达一个网络节点，就需要通过路由算法决定下一步哪条路径

路由器寻找工作中，就需要目标地址的子网，找到后进而把数据包发送到对应的网络内

![IP地址的网络号](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/17.jpg)

所以，**IP 协议的寻址作用是告诉我们去往下一个目的地该朝哪个方向走，路由则是根据「下一个目的地」选择路径。寻址更像在导航，路由更像在操作方向盘**

## 网络接口层

---

生成IP头部后，接下来就是**网络接口层**(Link Layer)在IP头部的前面加上MAC头部，并封装成**数据帧**(Data frame)发送到网络上

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/https/%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%E5%B1%82.png)

IP 头部中的接收方 IP 地址表示网络包的目的地，通过这个地址我们就可以判断要将包发到哪里，但在以太网的世界中，这个思路是行不通的。

什么是以太网呢？电脑上的以太网接口，Wi-Fi接口，以太网交换机、路由器上的千兆，万兆以太网口，还有网线，它们都是以太网的组成部分。以太网就是一种在「局域网」内，把附近的设备连接起来，使它们之间可以进行通讯的技术。

以太网在判断网络包目的地时和 IP 的方式不同，因此必须采用相匹配的方式才能在以太网中将包发往目的地，而 MAC 头部就是干这个用的，所以，在以太网进行通讯要用到 MAC 地址。

MAC 头部是以太网使用的头部，它包含了接收方和发送方的 MAC 地址等信息，我们可以通过 ARP 协议获取对方的 MAC 地址。

所以说，网络接口层主要为网络层提供「链路级别」传输的服务，负责在以太网、WiFi 这样的底层网络上发送原始数据包，工作在网卡这个层次，使用 MAC 地址来标识网络上的设备。

## 总结

---

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/tcpip%E5%8F%82%E8%80%83%E6%A8%A1%E5%9E%8B.drawio.png)

综上所述，TCP/IP 网络通常是由上到下分成 4 层，分别是**应用层，传输层，网络层和网络接口层**。

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost3@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%B5%AE%E7%82%B9/%E5%B0%81%E8%A3%85.png)

网络接口层的传输单位是帧（frame），IP 层的传输单位是包（packet），TCP 层的传输单位是段（segment），HTTP 的传输单位则是消息或报文（message）。但这些名词并没有什么本质的区分，可以统称为数据包。