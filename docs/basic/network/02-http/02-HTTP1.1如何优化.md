# 3.2 - HTTP/1.1如何优化

+ 尽量避免发送HTTP请求
  + 缓存
+ 在需要发送HTTP请求时，考虑减少请求次数
  + 减少重定向请求次数
  + 合并请求
  + 延迟发送请求
+ 减少服务器的HTTP响应的数据大小
  + 无损压缩
  + 有损压缩

## 如何避免发送HTTP请求

使用**缓存技术**，把`请求-响应`的数据缓存在本地

![http缓存](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/http1.1%E4%BC%98%E5%8C%96/%E7%BC%93%E5%AD%98etag.png)

## 如何减少HTTP请求次数

减少HTTP请求次数，从这个三个方面入手：

+ 减少重定向请求次数

重定向交由**代理服务器**处理，同时代理服务器可以知晓（记录）重定向规则，进一步减少消息传递次数

+ 合并请求

将多个访问小文件的请求合并为一个大请求，减少重复发送的HTTP头部

合并请求的方式就是合并资源，以一个大资源的请求替换多个小资源的请求，但是这样合并也带来了新的问题，当大资源中的某一个小资源发生变化后，客户端必须重新下载整个完整的大资源文件

+ 延迟发送请求

简单讲：就是按照需求，减少第一时间需要的HTTP请求，以减少HTTP请求压力

## 如何减少HTTP响应的数据大小

考虑对响应的资源进行**压缩**，以达到减少响应的数据大小，而提高网络传输的效率

压缩的方式分两种：

+ 无损压缩

无损压缩，指资源经过压缩后，信息不被破环，还能完全恢复到压缩前的原样

`gzip`：比较常见的无损压缩算法，会在HTTP请求中通过头部的`Accept-Encoding`字段告诉服务器：

```
Accept-Encoding: gzip, deflate, br
```

服务器收到后，根据压缩算法对资源进行压缩，最后通过头部中的`Content-Encoding`字段告诉客户端资源使用的压缩算法

```
Content-Encoding: gzip
```

+ 有损压缩

有损压缩的发生是指经过该方法压缩、解压的数据会与原始数据不同但是十分接近

主要用于：多媒体数据，音频、视频、图片等

在HTTP请求的头部`Accept`字段里的"q质量因子"，告诉服务器期望的资源质量

```
Accept: audio/*; q=0.2; audio/basic
```

## 总结

优化HTTP/1.1协议的思路

第一个思路是，通过缓存技术来避免发送 HTTP 请求。客户端收到第一个请求的响应后，可以将其缓存在本地磁盘，下次请求的时候，如果缓存没过期，就直接读取本地缓存的响应数据。如果缓存过期，客户端发送请求的时候带上响应数据的摘要，服务器比对后发现资源没有变化，就发出不带包体的 304 响应，告诉客户端缓存的响应仍然有效。

第二个思路是，减少 HTTP 请求的次数，有以下的方法：

1. 将原本由客户端处理的重定向请求，交给代理服务器处理，这样可以减少重定向请求的次数；
2. 将多个小资源合并成一个大资源再传输，能够减少 HTTP 请求次数以及 头部的重复传输，再来减少 TCP 连接数量，进而省去 TCP 握手和慢启动的网络消耗；
3. 按需访问资源，只访问当前用户看得到/用得到的资源，当客户往下滑动，再访问接下来的资源，以此达到延迟请求，也就减少了同一时间的 HTTP 请求次数。

第三思路是，通过压缩响应资源，降低传输资源的大小，从而提高传输效率，所以应当选择更优秀的压缩算法。